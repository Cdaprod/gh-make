#!/usr/bin/env bash

set -e

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_color() {
  local color=$1
  local message=$2
  echo -e "${color}${message}${NC}"
}

# Determine the extension directory
EXTENSION_DIR="$HOME/.local/share/gh/extensions/gh-make"

# Ensure the extension directory exists
mkdir -p "$EXTENSION_DIR"

# Define the path for the main script
MAIN_SCRIPT="$EXTENSION_DIR/gh-make"

# Function to update the main script
update_main_script() {
  print_color $BLUE "Updating gh-make script..."
  cat > "$MAIN_SCRIPT" << 'EOL'
#!/usr/bin/env bash

# [Insert the entire content of the gh-make script here]
# This should be the full interactive script we created earlier

EOL

  chmod +x "$MAIN_SCRIPT"
  print_color $GREEN "gh-make script updated and set as executable."
}

# Check if the script exists and update it
if [ -f "$MAIN_SCRIPT" ]; then
  print_color $YELLOW "Existing gh-make script found. Updating..."
  update_main_script
else
  print_color $YELLOW "gh-make script not found. Creating new script..."
  update_main_script
fi

# Verify the installation
if gh extension list | grep -q "gh-make"; then
  print_color $GREEN "gh-make extension is installed and up to date."
else
  print_color $RED "Error: gh-make extension not found in gh extensions list."
  print_color $YELLOW "Attempting to install gh-make extension..."
  gh extension install Cdaprod/gh-make
fi

print_color $BLUE "Setup complete. You can now use 'gh make' to run the extension."